---
title: "CB-mouthColor"
author: "Justin Mann"
date: "4/9/2021"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}
library(RColorBrewer); #brewer.pal(n=8, name = "Dark2") #;display.brewer.pal(n = 8, name = "Dark2")
library(tidyverse); theme_set(theme_classic()) #ggplot2, dplyr, tibble, etc.
library(plotly) #use ggplotly() for interactive plots with scoll-over IDs
library(knitr) #use kable() to make formatted tables
library(kableExtra)
library(Rtsne)
library(glmmTMB)
library(lme4)
library(sjPlot)
library(ggpubr) #ggarrange() figure wraps
library(plyr)
library(ggeffects) #ggpredict
library(rstanarm) #stan models
library(shinystan) #stan model evaluation >launch_shinystan_demo()
library(loo) #loo() to compare fits between bayesian models
library(MuMIn) #dredge, model averaging
library(AICcmodavg) #aictab() for AICc model comparisons
library(coin) #permutation test for ratios with independence_test()
library(janitor) #get_dupes() finds and prints duplicates
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<br>

### <b>Read in mouth color data (mc)</b>
<br>
<b>Replace zeros with NAs, sort and filter by age (23-27)</b>
```{r mouth color dataframe}
mc=tibble(read.csv("CB-mouthColor.csv", h=T)) #N=225
#replace zeros with NAs in morphometrics 
mc[mc==0] <- NA
#sort by year > family > id
mc <- mc %>% arrange(year, family, id) #N=225
#filter to include only ages 23-27
mc <- mc %>% filter(between(age,23,27)) #N=141
mc <- mc %>% drop_na(sex) #N=138
```
<br>

<b>Identify duplicate records in mc</b>
```{r find and remove duplicate records in mc}
mc %>% get_dupes(id)
```
For these duplicate records, one record for each individual is missing time 2 measurements. Therefore, I am keeping
only the complete record for each individual.
Removed = 42 ROWA04 (row 137), 53 ROWA04 (row 138), 64 ROWA04 (row 139), 75 ROWA04 (row 140)
```{r}
mc <- mc[-c(62,67,72,78),]#N=134
#mc %>% get_dupes() #double check...yep, no duplicates
```

<b>Create subsets of mc for females (N=80) and males (N=54) only</b>
```{r subset mc by sex}
#females only
female.mc <- mc %>% 
  filter(sex == "F") #N=80
#males only
male.mc <- mc %>% 
  filter(sex == "M") #N=54
```
<br>

### <b>Read in nestling morphometrics data (nm)</b>
<br>
<b>Nestling morphometrics are being used here to boost sample size for calculating mass/tarsus residuals</b>
<br>
<b>Replace zeros with NAs, sort and filter by age (23-27)</b> 
```{r nestling morphometrics dataframe}
nm=tibble(read.csv("nestlingMorph.csv", h=T))
#replace zeros with NAs in morphometrics 
nm[nm==0] <- NA
#remove nestlingMeasurementNumber
nm <- nm[,-1]
#sort by year > nestName > id
nm <- nm %>% arrange(year, nestName ,id)
#filter to include only ages 23-27
nm <- nm %>% filter(between(age, 23, 27)) 
```
<br>

<b>Create subset of nm including only sexed birds (N=503; females=268; males=235)</b>
```{r subset nm for sexed birds}
#subset nm to include only sexed birds and remove NAs from mass & tarsus
sexed.nm <- nm %>% drop_na(sex, tarsus, mass) #N=503
#make sex a factor rather than character
sexed.nm$sex <- as.factor(sexed.nm$sex)
#females only 
female.nm <- sexed.nm %>% 
  filter(sex == "F") #N=268
#males only
male.nm <- sexed.nm %>% 
  filter(sex == "M") #N=235
```
<br>

### Plot--mass distribution by sex
<br>

<b>Only includes sexed individuals (N=503)</b>
```{r mass distribution by sex}
sexed.nm %>% 
  ggplot(aes(mass, fill=sex))+
  geom_histogram(binwidth = 10)+
  scale_fill_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))+
  annotate(geom = "text", x=375, y=29, label="N=268")+
  annotate(geom = "text", x=390, y=5, label="N=235")
```
<br>

### Plot--tarsus distribution by sex
<br>

<b>Only includes sexed individuals (N=503)</b>
```{r tarsus distribution by sex}
sexed.nm %>% 
  ggplot(aes(tarsus, fill=sex))+
  geom_histogram(binwidth = 0.5)+
  scale_fill_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))+
  annotate(geom = "text", x=59, y=28, label="N=268")+
  annotate(geom = "text", x=60, y=5, label="N=235")
```
<br>

### Plot--mass by tarsus with sex filter (N=503)
```{r Plot--weight ~ tarsus with sex filter}
sexed.nm %>% 
  ggplot(aes(x=tarsus,y=mass,color=sex))+
  geom_point(alpha=0.5)+
  geom_smooth()+
  scale_color_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))
```
<br>


### Create the female mass~tarsus residual index
```{r}
femaleIndex.lm <- lm(mass~tarsus, female.nm)
summary(femaleIndex.lm)
```
<br>

<b>Check residual distributions</b>
<br>

*Q-Q plot looks a little non-normal, probably seeing the effects of reduced sample size by separating sexes.
```{r}
plot(femaleIndex.lm)
```
<br>

### Plot--female mass~tarsus
```{r Plot--female mass~tarsus}
female.nm %>% 
  ggplot(aes(x=tarsus, y=mass, color=as.factor(age)))+
  geom_point(alpha = 0.5)+
  geom_smooth(aes(group=1))+
  scale_color_brewer(palette = "Set1")
```
<br>

### Create male mass~tarsus residual index
<br> 
```{r}
maleIndex.lm <- lm(mass~tarsus, male.nm)
summary(maleIndex.lm)
```
<br>

<b>Plot residuals</b>
```{r}
plot(maleIndex.lm)
```
<br>

### Plot--male tarsus~mass
```{r Plot--male mass~tarsus}
male.nm %>% 
  ggplot(aes(x=tarsus, y=mass, color=as.factor(age)))+
  geom_point(alpha = 0.5)+
  geom_smooth(aes(group=1))+
  scale_color_brewer(palette = "Set1")
```
<br>

<b>Create dataframes containing id and residuals</b>
```{r residual dataframes}
#male residuals pulled from lm() output
male.nm$resids <- maleIndex.lm$residuals
#female residuals pulled from lm() output
female.nm$resids <- femaleIndex.lm$residuals

#dataframes containing male and female ids and residuals for the join with mc
joinMaleResidual <- data.frame(id = male.nm$id,
                               resids = male.nm$resids)
joinFemaleResidual <- data.frame(id = female.nm$id,
                                 resids = female.nm$resids)
```
<br>

<b>Join residuals with male and female mouth color data by common id</b>
```{r}
#left join with female mc
newFemale.mc <- left_join(female.mc,joinFemaleResidual, by="id")
female.mc$resids <- newFemale.mc$resids

#left join with male mc
newMale.mc <- left_join(male.mc,joinMaleResidual, by="id")
male.mc$resids <- newMale.mc$resids

#left join with both sexes (full mc) 
bothSexResid <- data.frame(rbind(joinMaleResidual,joinFemaleResidual))
new.mc <- left_join(mc,bothSexResid, by="id")
mc$resids <- new.mc$resids
```
<br>

<b>Distribution of residuals for both sexes combined</b>
```{r histogram of male and female residuals combined}
mc %>%
  ggplot(aes(x=resids, fill=sex))+
  geom_histogram(binwidth = 10)+
  scale_fill_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))
```
<br>

### Calculate mass/tarsus ratio and append a ratio column to sexed.nm
```{r calculate mass/tarsus ratio}
sexed.nm$ratio <- sexed.nm$mass/sexed.nm$tarsus
```
<br> 

### Permutation test to assess independence of male and female ratios
reference: https://stats.stackexchange.com/questions/23152/test-for-significant-difference-in-ratios-of-normally-distributed-random-variabl 
```{r mass/tarsus ratio t test}
independence_test(ratio~sex, data = sexed.nm)
```
<br>

This result doesn't indicate the direction of the relationship, but simply indicates
that the female ratio is statistically different than the male ratio. This suggests that
modeling male and female mouth color separately is likely best. 
<br>

Plotting mass/tarsus ratio by sex
```{r}
sexed.nm %>% 
  ggplot(aes(x=sex, y=ratio, color=sex))+
  geom_boxplot()+
  ylab("Mass/tarsus ratio")+
  scale_color_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))+
  geom_jitter(alpha=0.2)
```
<br>

<b>Examine whether brood size affects body temp</b>
<br>

Plotting body temp by brood size
```{r}
bodyTempByBroodSize.plot <- mc %>% 
  ggplot(aes(x=broodSize,y=bodTemp1, 
             group=as.factor(broodSize), color=as.factor(broodSize),
             label=id))+
  geom_boxplot()+
  geom_jitter()+
  scale_color_brewer(palette = "Dark2")
ggplotly(bodyTempByBroodSize.plot)
```
<br>

Contrary to our expectation, it looks like the largest broods (6 nestlings) is significantly lower in body temp on average, but it's the smallest sample. Probably shouldn't try to infer much, but at least we aren't seeing big differences across brood sizes on the whole. 
<br>

<br>
```{r}
summary(lm(bodTemp1~as.factor(broodSize), data = mc))
```
<br>

### Create mass/tarsus ratio column in mc for use in models
```{r}
mc$ratio <- mc$mass/mc$tarsus
```
<br>

<b>Distribution of mass/tarsus ratio for both sexes combined</b>
```{r histogram of male and female ratios combined}
mc %>%
  ggplot(aes(x=ratio, fill=sex))+
  geom_histogram(binwidth = 0.4)+
  scale_fill_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))
#hist(mc$ratio)
```
<br>

## SATURATION MODELS
<br>

### Sat 1 models with sexes combined
<br>

### <b>Sat1 ~ mass/tarsus ratio model</b>
```{r}
sat1Ratio.mdl <- lmer(sat1 ~ age + ratio + sex + 
                        bodTemp1 + ambTemp1 + timeOut1 + (1|family), 
                    data = mc, REML = FALSE)
summary(sat1Ratio.mdl)
```

Plot ratio model
```{r}
plot_model(sat1Ratio.mdl,
           title = "Mass/tarsus ratio model for saturation 1",
           bpe = "median",
           vline.color = "black",
           show.values = TRUE, 
           value.offset = .3,
           line.size = 1.2)
```
<br>

### <b>Sat1 ~ mass/tarsus residual model</b>
```{r}
sat1Residual.mdl <- lmer(sat1 ~ age + resids + sex + 
                           bodTemp1 + ambTemp1 + timeOut1 + (1|family), 
                    data = mc, REML = FALSE)
summary(sat1Residual.mdl)
```
<br>

Plot residual model
```{r}
plot_model(sat1Residual.mdl,
           title = "Mass/tarsus residual model for saturation 1",
           bpe = "median",
           vline.color = "black",
           show.values = TRUE, 
           value.offset = .3,
           line.size = 1.2)
```
<br>
<b>Now let's compare the fit of ratio and residual models</b>
```{r}
ratioOrResid.mdls <- c(sat1Ratio.mdl, sat1Residual.mdl)
ratioOrResid.modnames <- c("Ratio", "Residual")
confset(ratioOrResid.mdls, modnames = ratioOrResid.modnames, method = "ordinal")
```
<br>

Using AICc Weight (AICcWt), the confset() function calculates the probability of each model (i.e. each hypothesis) given the data and the other candidate models. So in this case, we have more confidence in the ratio models ability to explain the variation in the data, even though their AICc values are only slightly different.

<br>
```{r}
sat1NoSex.mdl <- lmer(sat1 ~ age + resids + bodTemp1 + ambTemp1 + timeOut1 + (1|family), 
                    data = mc, REML = FALSE)
```


```{r}
sat1NoSex.mdl2 <- lmer(sat1 ~ age + resids + bodTemp1 * ambTemp1 + (1|family), 
                    data = mc, REML = FALSE)
```


```{r}
sat1NoSex.mdl3 <- lmer(sat1 ~ age + resids + bodTemp1 + (1|family), 
                    data = mc, REML = FALSE)
```
<br>

In the following model, we're using the difference between body temp and 41 degrees, which is the mean body temp for birds > 28 days old. We chose this age range since these mature nestlings should have had an easier time maintaining an 'ideal' body temp. 
<br>

```{r}
#calculate the difference between each birds body temp and 41 degrees (mean of birds >28 days of age)
mc$tempDiff <- mc$bodTemp1-41
#model including tempDiff
diffTemp.mdl <- lmer(sat1 ~ age + resids + tempDiff + (1|family), data = mc, REML = FALSE)
summary(diffTemp.mdl)
```
```{r}
plot_model(diffTemp.mdl,
           title = "Both sexes saturation 1",
           bpe = "median",
           vline.color = "black",
           show.values = TRUE, 
           value.offset = .3,
           line.size = 1.2)
```
<br>

```{r}
# AIC(sat1Sex.mdl, sat1NoSex.mdl)
# sexOrNo <- c(sat1Sex.mdl, sat1NoSex.mdl, ratioSex.mdl, sat1NoSex.mdl2, sat1NoSex.mdl3)
# modname <- c("sex", "no", "ratio", "noTimeOut", "noAmbTemp")
# confset(sexOrNo, modnames = modname, method = "ordinal")
```
<br>

## HUE MODELS
```{r}
hue1.mdl <- lmer(hue1*100 ~ age + ratio + sex + bodTemp1 + ambTemp1 + timeOut1 + (1|family), 
                    data = mc, REML = FALSE)
```
<br>

```{r}
plot_model(hue1.mdl,
           title = "Ratio hue 1",
           bpe = "median",
           vline.color = "black",
           show.values = TRUE, 
           value.offset = .3,
           line.size = 1.2)
```
