---
title: "CB-mouthColor"
author: "Justin Mann"
date: "3/19/2021"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}
library(RColorBrewer) ;brewer.pal(n=8, name = "Dark2") #;display.brewer.pal(n = 8, name = "Dark2")
library(tidyverse) #ggplot2, dplyr, tibble, etc.
library(plotly) #use ggplotly() for interactive plots with scoll-over IDs
library(knitr) #use kable() to make formatted tables
library(Rtsne)
library(glmmTMB)
library(lme4)
library(sjPlot)
library(ggpubr) #ggarrange() figure wraps
library(plyr)
library(ggeffects) #ggpredict
library(rstanarm) #stan models
library(shinystan) #stan model evaluation >launch_shinystan_demo()
library(loo) #loo() to compare fits between bayesian models
library(MuMIn) #dredge, model averaging
library(AICcmodavg) #aictab() for AICc model comparisons
```
<br>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
theme_set(theme_classic())
```

## Read in mouth color data (mc)
<br>

```{r mouth color dataframe}
mc=tibble(read.csv("CB-mouthColor.csv", h=T))
#replace zeros with NAs in morphometrics 
mc[mc==0] <- NA
#sort by year > family > id
mc <- mc %>% arrange(year, family, id) #N=225
#filter to include only ages 23-27
mc <- mc %>% filter(between(age,23,27)) #N=141
```
<br>

```{r subset mc by sex}
#females only
female.mc <- mc %>% 
  filter(sex == "F") #N=82
#males only
male.mc <- mc %>% 
  filter(sex == "M") #N=56
```


## Read in nestling morphometrics data (nm)
<br>

```{r nestling morphometrics dataframe}
nm=tibble(read.csv("nestlingMorph.csv", h=T))
#replace zeros with NAs in morphometrics 
nm[nm==0] <- NA
#remove nestlingMeasurementNumber
nm <- nm[,-1]
#sort by year > nestName > id
nm <- nm %>% arrange(year, nestName ,id)
#filter to include only ages 23-27
nm <- nm %>% filter(between(age, 23, 27))
```
<br>

```{r subset nm for sexed birds}
#subset nm to include only sexed birds and remove NAs from mass & tarsus
sexed.nm <- nm %>% drop_na(sex, tarsus, mass) #N=503
#make sex a factor rather than character
sexed.nm$sex <- as.factor(sexed.nm$sex)
#females only 
female.nm <- sexed.nm %>% 
  filter(sex == "F") #N=268
#males only
male.nm <- sexed.nm %>% 
  filter(sex == "M") #N=235
```


## Do we need to control for repeated measurements of birds in mass~tarsus.mdl
```{r do we control repeated id}
noRandId.mdl_outliers <- lm(mass~tarsus, data = nm)
plot(noRandId.mdl_outliers)
```
```{r}
nm[c(437,743,1012,1038,1514),c(5,10,22)]
```

## Remove outliers as identified by residual distribution plots
```{r do we control repeated id (remove outliers)}
noRandId.mdl1 <- lm(mass~tarsus, data = nm[-c(437,743,1012,1038,1514),])
plot(noRandId.mdl1)
```
<br>
## Remove outliers for calculation of nm mass~tarsus residuals
```{r remove outliers from mass~tarus.mdls}
tarsusMass.nm <- nm[-c(437,743,1012,1038,1514),] #n=1531 (five birds removed confirmed)
#remove NAs from tarsus & mass
tarsusMass.nm <- drop_na(tarsusMass.nm, tarsus, mass)
#rerun mass~tarsus.mdl
noRandId.mdl2 <- lm(mass~tarsus, data = tarsusMass.nm)
plot(noRandId.mdl2)
```
```{r}
summary(noRandId.mdl2)
```

```{r}
randId.mdl <- lmer(mass~tarsus + (1|id), data = tarsusMass.nm, REML = FALSE)
summary(randId.mdl)
AIC(noRandId.mdl2,randId.mdl)
```
```{r}
plot(randId.mdl, col="black")
```
<br>
## Plot--weight by tarsus: no sex filter (N=1513)
```{r Plot--weight~tarsus}
tarsusMass.nm %>% 
  ggplot(aes(x=tarsus,y=mass,color=as.factor(age)))+
  geom_point(alpha=0.5)+
  scale_color_brewer(palette = "Set1")
```
<br>
```{r mass distribution by sex}
sexed.nm %>% 
  ggplot(aes(mass, fill=sex))+
  geom_histogram(binwidth = 10)+
  scale_fill_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))+
  annotate(geom = "text", x=375, y=29, label="N=268")+
  annotate(geom = "text", x=390, y=5, label="N=235")
```


<br>
```{r tarsus distribution by sex}
sexed.nm %>% 
  ggplot(aes(tarsus, fill=sex))+
  geom_histogram(binwidth = 0.5)+
  scale_fill_manual(values = c("#1B9E77", "#D73027"),
                    name = "",
                    labels = c("Female","Male"))+
  annotate(geom = "text", x=59, y=28, label="N=268")+
  annotate(geom = "text", x=60, y=5, label="N=235")
```

<br>
```{r Plot--weight ~ tarsus with sex filter}
sexed.nm %>% 
  ggplot(aes(x=tarsus,y=mass,color=sex))+
  geom_point(alpha=0.5)+
  geom_smooth()+
  scale_color_manual(values = c("#1B9E77", "#D73027"),
                    name = "Sex",
                    labels = c("Female","Male"))
```
```{r}
femaleIndex.lm <- lm(mass~tarsus, female.nm)
summary(femaleIndex.lm)
```
```{r}
plot(femaleIndex.lm)
```
```{r Plot--female mass~tarsus}
female.nm %>% 
  ggplot(aes(x=tarsus, y=mass, color=as.factor(age)))+
  geom_point(alpha = 0.5)+
  geom_smooth(aes(group=1))+
  scale_color_brewer(palette = "Set1")
```
<br>
```{r}
maleIndex.lm <- lm(mass~tarsus, male.nm)
summary(maleIndex.lm)
```
<br>

```{r}
plot(maleIndex.lm)
```


```{r Plot--male mass~tarsus}
male.nm %>% 
  ggplot(aes(x=tarsus, y=mass, color=as.factor(age)))+
  geom_point(alpha = 0.5)+
  geom_smooth(aes(group=1))+
  scale_color_brewer(palette = "Set1")
```
<br>

```{r residual dataframes}
male.nm$residuals <- maleIndex.lm$residuals
female.nm$residuals <- femaleIndex.lm$residuals
joinMaleResidual <- data.frame(id = male.nm$id,
                               residuals = male.nm$residuals)
joinFemaleResidual <- data.frame(id = female.nm$id,
                                 residuals = female.nm$residuals)
```

```{r}
left_join(female.mc,joinFemaleResidual, by="id")
newFemale.mc <- left_join(female.mc,joinFemaleResidual, by="id")
female.mc$residuals <- newFemale.mc$residuals

newMale.mc <- left_join(male.mc,joinMaleResidual, by="id")
male.mc$residuals <- newMale.mc$residuals
```

```{r}
femaleSat1.mdl <- lmer(sat1~age + residuals + bodTemp1 + ambTemp1 + timeOut1 + (1|family), data = female.mc)
summary(femaleSat1.mdl)
plot_model(femaleSat1.mdl)
```


```{r}
maleSat1.mdl <- lmer(sat1~age + residuals + bodTemp1 + ambTemp1 + timeOut1 + (1|family), data = male.mc)
summary(maleSat1.mdl)
plot_model(maleSat1.mdl)
```


```{r}
# sat2_candset <- c(sat1_full.mdl,sat1_resid.mdl)
# mdls2 <- c("full", "residual")
# aictab(sat2_candset, modnames = mdls2, sort = TRUE)
```


Reduced models: fixed effects removed based on confidence intervals from the full model
```{r reduced models}
#sex random effect 
# sat1_rsex.mdl <- lmer(sat1 ~ weight + age + tarsus + bodTemp1 + ambTemp1 + (1|sex), 
#                  data = mc, REML = FALSE)
# #remove timeOut
# sat1_r1.mdl <- lmer(sat1 ~ weight + age + tarsus + sex + bodTemp1 + ambTemp1 + (1|family), 
#                  data = mc, REML = FALSE)
# #remove ambTemp
# sat1_r2.mdl <- lmer(sat1 ~ weight + age + tarsus + sex + bodTemp1 + (1|family), 
#                  data = mc, REML = FALSE)
# #remove bodTemp
# sat1_r3.mdl <- lmer(sat1 ~ weight + age + tarsus + sex + (1|family), 
#                  data = mc, REML = FALSE)
# sat1_candset <- c(sat1_full.mdl,sat1_rsex.mdl,sat1_r1.mdl,sat1_r2.mdl,sat1_r3.mdl)
# mdls <- c("full", "randSex", "r1", "r2", "r3")
# aictab(sat1_candset, modnames = mdls, sort = TRUE)
```


