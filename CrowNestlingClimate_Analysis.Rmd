---
title: "Nestling morphology responds to yearly fluctuations in temperature and precipitation"
author: "Justin Mann"
date: "2023-07-04"
output: html_document
---

```{r libraries, include=FALSE}
library(tidyverse)
library(broom) #tidy() to create tibbles from model summaries
library(car) #vif (variance inflation factor for measuring covariance)
library(cowplot)
library(lme4) #frequentist models  
library(sjPlot) #plot_model & tab_model (blue = #377EB8)
library(ggpubr) #ggarrange for plot wraps
library(lmerTest) #lmerTest::step
library(ggeffects) #ggpredict
#library(plotly) #ggplotly() to make interactive plots with scroll over ids
library(MuMIn) #dredge() for unsupervised model selection
library(AICcmodavg) #aictab() for AICc model comparisons
library(DHARMa) #model validation functions
library(DescTools) #Entropy() and MutInf()
library(lubridate) #Date conversions for weather data

#Libraries for Bayesian Models
library(rstanarm) #stan models
library(shinystan) #stan model evaluation
#launch_shinystan_demo()
library(loo) #use loo() to compare fits between bayesian models
library(broom.mixed) #rstanarm_tidiers() for tidying stan model summaries

theme_set(theme_classic()) #default plots with no gridlines
```

```{r colorblind accessible pallet}
colorBlindPal  <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r dfs for fplot function}
fplot_df <- function(model, dataset, metric) {
  df <- tidy(model, quick = FALSE)
  ci <- as_tibble(confint(model))
  df$ci.lower <- ci$`2.5 %`
  df$ci.upper <- ci$`97.5 %`
  df$Dataset <- dataset
  df$Metric <- metric
  df <- df[-1,]
  return(df)
}
```

```{r fplot function}
fplot <- function(metric) {
    ggplot(data = metric) +
        geom_errorbar(aes(x = term, ymin = ci.lower, ymax = ci.upper, color = Dataset),
                      linewidth = 1, width = 0.3, position = position_dodge(width = 0.4)) +
        geom_point(aes(x = term, y = estimate, color = Dataset), 
                   shape = 16, size = 3, position = position_dodge(width = 0.4)) +
        scale_color_manual(name = "", values = c("#000000", "#E69F00", "#56B4E9"),
                           labels = c("All", "Female", "Male")) +
        coord_flip() +
        geom_hline(yintercept = 0, color = "red", size = 1, linetype = "dotted") +
        scale_x_discrete(labels = c("Min Temp", "Min Temp * Precip", "Precip","Weight")) +
        ylab("Parameter estimate") +
        theme(plot.title = element_text(size = 16),
              axis.text.x = element_text(size = 12),
              axis.title.x = element_text(size = 14),
              axis.text.y = element_text(size = 14),
              axis.title.y = element_blank(),
              legend.position = "top",
              plot.margin = margin(15, 15, 15, 15))
}
```

## Import Nestling Data

```{r unscaled data}
df <- read.csv("CrowNestlingClimate_UnscaledData_7.8.23.csv", h=TRUE)
# n=2030 nestlings
```

## Import Weather Data

```{r clim.df}
clim.df <- read.csv("ClimateMetrics_AllMonths1989-2022.csv", h=T)
```

## Data Scaling

### Normalize Continuous Data
Subtract each value from the mean (center) and divide it by the standard deviation

```{r scaling}
#categorical data  
categorical.df <- df[,1:11]

#continuous data
continuous.df <- df[,12:46]

#scale continuous data
#?scale()
scaled.mat <- scale(continuous.df, center = TRUE, scale = TRUE)

#join unscaled and scaled data
scaled.df <- cbind(categorical.df,scaled.mat)
```

## Data frames for males, females and unknown sex

```{r sexes data frames}
#Males scaled
M.scaled.df <- subset(scaled.df, Sex=="M")
#Males unscaled
M.df <- subset(df, Sex=="M")

#Females scaled
F.scaled.df <- subset(scaled.df, Sex=="F")
#Females unscaled
F.df <- subset(df, Sex=="F")

#Unsexed scaled
U.scaled.df <- subset(scaled.df, Sex=="U")
#Unsexed unscaled
U.df <- subset(df, Sex=="U")

#Both sexes scaled
B.scaled.df <- rbind(F.scaled.df,M.scaled.df)
#Both sexes unscaled
B.df <- rbind(F.df,M.df)
```

## Summarizing Weather across Years

```{r breedingClim.df}
clim.df$Date <- as.Date(clim.df$Date)
clim.df$Month <- lubridate::month(clim.df$Date)
clim.df <- clim.df %>% 
  relocate(Month, .after = Year)
breedingClim.df <- clim.df %>% #filtering weather data to include only 1 March-30 June
  filter(between(Month, 3,6)) %>% 
  filter(between(JulDay, 60,181))
```

## Plotting minimum temperature and precipitation across years
```{r plot median min temp}
median(breedingClim.df$MinC, na.rm=TRUE)
min.plot <- ggplot(data = breedingClim.df, aes(x=as.factor(Year), y=MinC))+
  geom_boxplot()+
  geom_hline(yintercept = 1.67, color = "red", linetype = "dotted", linewidth = 1)+
  ylab("Minimum Temperature (C)")+
  xlab("")+
  theme(axis.text.x = element_text(angle = 90))
```

```{r plot precip}
median(breedingClim.df$PrecipCM, na.rm=TRUE)
precip.plot <- ggplot(data = clim.df, aes(x=as.factor(Year), y=PrecipCM))+
  geom_boxplot()+
  geom_hline(yintercept = 0.025, color = "red", linetype = "dotted", size = 1)+
  ylab("Precipitation (cm)")+
  xlab("")+
  theme(axis.text.x = element_text(angle = 90))
```

```{r wrap climate plots}
BreedingClimate.wrap <- ggarrange(min.plot,precip.plot, ncol = 1)
cowplot::save_plot("PaperPlots/BreedingClimate.wrap.png", BreedingClimate.wrap, base_height = 8, base_width = 6)
BreedingClimate.wrap
```
## Weight by Age Plot

```{r WeightAge.plot}
WeightAge.plot <- ggplot(data = df, aes(x = CalcAge, y = Weight, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method = "lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="Sex",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unsexed"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Weight (g)")+
  xlab("Nestling age (days)")
suppressWarnings(print(WeightAge.plot))
#cowplot::save_plot("Plots/WeightAge.plot.png", WeightAge.plot, base_height = 4, base_width = 7)
```


## Nestling Weight

### Weight by Minimum Temperature Plot

```{r WeightMinC.plot}
WeightMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = Weight, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unsexed"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Weight (g)")+
  xlab("Average minimum temperature (C)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
suppressWarnings(print(WeightMinC.plot))
#cowplot::save_plot("Plots/WeightMinC.plot.png", WeightMinC.plot, base_height = 4, base_width = 7)
```

### Male Weight Model

```{r M.Weight.mdl}
M.Weight.mdl <- lm(Weight ~ MinC8_22 * PrecipSum8_22, data = M.scaled.df)
summary(M.Weight.mdl)
```

### Female Weight Model

```{r F.Weight.mdl}
F.Weight.mdl <- lm(Weight ~ MinC8_22 * PrecipSum8_22, data = F.scaled.df)
summary(F.Weight.mdl)
```

### All Nestlings Weight Model

```{r A.Weight.mdl}
A.Weight.mdl <- lm(Weight ~ MinC8_22 * PrecipSum8_22, data = scaled.df)
summary(A.Weight.mdl)
```

### Dataframes for Weight Forest Plot

```{r Weight.dfs for fplot}
M.Weight.df <- fplot_df(M.Weight.mdl, "Male", "Weight")
F.Weight.df <- fplot_df(F.Weight.mdl, "Female", "Weight")
A.Weight.df <- fplot_df(A.Weight.mdl, "All", "Weight")

Weight.df <- rbind(M.Weight.df, F.Weight.df, A.Weight.df)
```

### Weight Forest Plot

```{r Weight.fplot}
Weight.fplot <- fplot(Weight.df)
Weight.fplot
#cowplot::save_plot("Plots/Weight.fplot.png", Weight.fplot, base_height = 4, base_width = 7)
```

### Weight Plots Wrapped

```{r Weight.wrap}
Weight.wrap <- ggarrange(WeightMinC.plot, Weight.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
Weight.wrap

cowplot::save_plot("PaperPlots/Weight.wrap.png", Weight.wrap, base_height = 5, base_width = 10)
```


## Nestling Tarsus 

### Tarsus by Minimum Temperature Plot

```{r TarsusMinC.plot}
TarsusMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = Tarsus, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unsexed"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Tarsus (mm)")+
  xlab("Average minimum temperature (C)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
suppressWarnings(print(TarsusMinC.plot))
#cowplot::save_plot("Plots/TarsusMinC.plot.png", TarsusMinC.plot, base_height = 4, base_width = 7)
```

### Male Tarsus Model

```{r M.Tarsus.mdl}
M.Tarsus.mdl <- lm(Tarsus ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.Tarsus.mdl)
```

### Female Tarsus Model

```{r F.Tarsus.mdl}
F.Tarsus.mdl <- lm(Tarsus ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.Tarsus.mdl)
```


### All Nestlings Tarsus Model

```{r A.Tarsus.mdl}
A.Tarsus.mdl <- lm(Tarsus ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.Tarsus.mdl)
```


### Data frames for Tarsus Forest Plots

```{r Tarsus.dfs for fplot}
M.Tarsus.df <- fplot_df(M.Tarsus.mdl, "Male", "Tarsus")
F.Tarsus.df <- fplot_df(F.Tarsus.mdl, "Female", "Tarsus")
A.Tarsus.df <- fplot_df(A.Tarsus.mdl, "All", "Tarsus")

Tarsus.df <- rbind(M.Tarsus.df, F.Tarsus.df, A.Tarsus.df)
```

### Tarsus Forest Plot

```{r Tarsus.fplot}
Tarsus.fplot <- fplot(Tarsus.df)
Tarsus.fplot
#cowplot::save_plot("Plots/Tarsus.fplot.png", Tarsus.fplot, base_height = 4, base_width = 7)
```

### Tarsus Plots Wrapped

```{r Tarsus.wrap}
Tarsus.wrap <- ggarrange(TarsusMinC.plot, Tarsus.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
suppressWarnings(print(Tarsus.wrap))
cowplot::save_plot("PaperPlots/Tarsus.wrap.png", Tarsus.wrap, base_height = 5, base_width = 10)
```

## Nestling Skull

### Skull by Minimum Temperature Plot

```{r SkullMinC.plot}
SkullMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = Skull, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unsexed"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  labs(x = "Average minimum temperature (C)", y = "Skull (mm)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
SkullMinC.plot
#cowplot::save_plot("Plots/SkullMinC.plot.png", SkullMinC.plot, base_height = 4, base_width = 7)
```

### Male Skull Model

```{r M.Skull.mdl}
M.Skull.mdl <- lm(Skull ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.Skull.mdl)
```

### Female Skull Model

```{r F.Skull.mdl}
F.Skull.mdl <- lm(Skull ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.Skull.mdl)
```

### All Nestlings Skull Model

```{r A.Skull.mdl}
A.Skull.mdl <- lm(Skull ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.Skull.mdl)
```

### All nestlings Skull model with no interaction

```{r A.SkullNoInter.mdl}
A.SkullNoInter.mdl <- lm(Skull ~ MinC8_22 + PrecipSum8_22 + Weight, data = scaled.df)
summary(A.SkullNoInter.mdl)
```

### All nestlings Skull model with only temperature and weight

```{r A.SkullNoPrecip.mdl}
A.SkullNoPrecip.mdl <- lm(Skull ~ MinC8_22 + Weight, data = scaled.df)
summary(A.SkullNoPrecip.mdl)
```

### Data frames for Skull Forest Plot

```{r Skull.dfs for fplot}
M.Skull.df <- fplot_df(M.Skull.mdl, "Male", "Skull")
F.Skull.df <- fplot_df(F.Skull.mdl, "Female", "Skull")
A.Skull.df <- fplot_df(A.Skull.mdl, "All", "Skull")

Skull.df <- rbind(M.Skull.df, F.Skull.df, A.Skull.df)
```

### Skull Forest Plot

```{r Skull.fplot}
Skull.fplot <- fplot(Skull.df)
Skull.fplot
#cowplot::save_plot("Plots/Skull.fplot.png", Skull.fplot, base_height = 4, base_width = 7)
```

###Skull Interaction plot 
```{r Skull. interaction plot}
Skull.Inter.plot <- plot_model(A.Skull.mdl, type = "int", mdrt.values = "quart")+
  scale_color_manual(name="Precipitation levels",
                    values=c("#D81B60","#FFC107","#1E88E5"),
                    labels=c("Low","Median","High"))+
  scale_fill_manual(values = c("#D81B60","#FFC107","#1E88E5"))+
  ggtitle("")+
  xlab("Average minimum temperature scaled (C)")+
  ylab("Skull scaled (mm)")+
  theme(plot.title = element_text(size = 14, hjust = 0.5),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = c(0.2,0.8))
Skull.Inter.plot
```

### Skull Plots Wrapped

```{r Skull.wrap}
Skull.wrap <- ggarrange(Skull.Inter.plot, Skull.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
suppressWarnings(print(Skull.wrap))
cowplot::save_plot("PaperPlots/Skull.wrap.png", Skull.wrap, base_height = 5, base_width = 10)
```

## Nestling Bill Depth

### Bill Depth by Minimum Temperature Plot

```{r BDMinC.plot}
BDMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = BD, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unsexed"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Bill depth (mm)")+
  xlab("Average minimum temperature (C)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
BDMinC.plot
#cowplot::save_plot("Plots/BDMinC.plot.png", BDMinC.plot, base_height = 4, base_width = 7)
```

### Male Bill Depth Model

```{r M.BD.mdl}
M.BD.mdl <- lm(BD ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.BD.mdl)
```


### Female Bill Depth Model

```{r F.BD.mdl}
F.BD.mdl <- lm(BD ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.BD.mdl)
```

### All Nestlings Bill Depth Model

```{r A.BD.mdl}
A.BD.mdl <- lm(BD ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.BD.mdl)
```

### Data frames for Bill Depth Forest Plots

```{r BD.dfs for fplot}
M.BD.df <- fplot_df(M.BD.mdl, "Male", "BD")
F.BD.df <- fplot_df(F.BD.mdl, "Female", "BD")
A.BD.df <- fplot_df(A.BD.mdl, "All", "BD")

BD.df <- rbind(M.BD.df, F.BD.df, A.BD.df)
```

### BD Forest Plot

```{r BD.fplot}
BD.fplot <- fplot(BD.df)
BD.fplot
#cowplot::save_plot("Plots/BD.fplot.png", BD.fplot, base_height = 4, base_width = 7)
```

### BD Plots Wrapped

```{r BD.wrap}
BD.wrap <- ggarrange(BDMinC.plot, BD.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
suppressWarnings(print(BD.wrap))
cowplot::save_plot("PaperPlots/BD.wrap.png", BD.wrap, base_height = 5, base_width = 10)
```

## Nestling Upper Bill (UB) 

### UB by Minimum Temperature Plot

```{r UBMinC.plot}
UBMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = UB, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unknown"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Upper bill (mm)")+
  xlab("Average minimum temperature (C)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
UBMinC.plot
#cowplot::save_plot("Plots/UBMinC.plot.png", UBMinC.plot, base_height = 4, base_width = 7)
```

### Male UB Model

```{r M.UB.mdl}
M.UB.mdl <- lm(UB ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.UB.mdl)
```


### Female UB Model

```{r F.UB.mdl}
F.UB.mdl <- lm(UB ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.UB.mdl)
```


### All Nestlings UB Model

```{r A.UB.mdl}
A.UB.mdl <- lm(UB ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.UB.mdl)
```

### Data frames for Upper Bill Forest Plots

```{r UB.dfs for fplot}
M.UB.df <- fplot_df(M.UB.mdl, "Male", "UB")
F.UB.df <- fplot_df(F.UB.mdl, "Female", "UB")
A.UB.df <- fplot_df(A.UB.mdl, "All", "UB")

UB.df <- rbind(M.UB.df, F.UB.df, A.UB.df)
```

### UB Forest Plot

```{r UB.fplot}
UB.fplot <- fplot(UB.df)
UB.fplot
#cowplot::save_plot("Plots/UB.fplot.png", UB.fplot, base_height = 4, base_width = 7)
```

###Upper Bill interaction plot

```{r UB.interaction plot}
UB.Inter.plot <- plot_model(A.UB.mdl, type = "int", mdrt.values = "quart")+
  scale_color_manual(name="Precipitation levels",
                    values=c("#D81B60","#FFC107","#1E88E5"),
                    labels=c("Low","Median","High"))+
  scale_fill_manual(values = c("#D81B60","#FFC107","#1E88E5"))+
  ggtitle("")+
  xlab("Average minimum temperature scaled (C)")+
  ylab("Upper bill scaled (mm)")+
  theme(plot.title = element_text(size = 14, hjust = 0.5),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = c(0.3,0.9))
UB.Inter.plot
```

### UB Plots Wrapped

```{r UB.wrap}
UB.wrap <- ggarrange(UB.Inter.plot, UB.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
suppressWarnings(print(UB.wrap))
cowplot::save_plot("PaperPlots/UB.wrap.png", UB.wrap, base_height = 5, base_width = 10)
```


## Nestling Upper Bill Surface Area (UBS) 

### UBS by Minimum Temperature Plot

```{r UBSMinC.plot}
UBSMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = UBS, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="Sex",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unknown"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  labs(x = "Average minimum temperature (C)", y = bquote('Upper bill surface area' ~(mm^2)))+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
UBSMinC.plot
#cowplot::save_plot("Plots/UBSMinC.plot.png", UBSMinC.plot, base_height = 4, base_width = 7)
```

### Male UBS Model

```{r M.UBS.mdl}
M.UBS.mdl <- lm(UBS ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.UBS.mdl)
```

### Female UBS Model

```{r F.UBS.mdl}
F.UBS.mdl <- lm(UBS ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.UBS.mdl)
```

### All Nestlings UBS Model

```{r A.UBS.mdl}
A.UBS.mdl <- lm(UBS ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.UBS.mdl)
```

### Data frames for UBS Forest Plot

```{r UBS.dfs for fplot}
M.UBS.df <- fplot_df(M.UBS.mdl, "Male", "UBS")
F.UBS.df <- fplot_df(F.UBS.mdl, "Female", "UBS")
A.UBS.df <- fplot_df(A.UBS.mdl, "All", "UBS")

UBS.df <- rbind(M.UBS.df, F.UBS.df, A.UBS.df)
```

### UBS Forest Plot

```{r UBS.fplot}
UBS.fplot <- fplot(UBS.df)
UBS.fplot
#cowplot::save_plot("Plots/UBS.fplot.png", UBS.fplot, base_height = 4, base_width = 7)
```

###UBS Interaction plot 
```{r UBS. interaction plot}
UBS.Inter.plot <- plot_model(A.UBS.mdl, type = "int", mdrt.values = "quart")+
  scale_color_manual(name="Precipitation levels",
                    values=c("#D81B60","#FFC107","#1E88E5"),
                    labels=c("Low","Median","High"))+
  scale_fill_manual(values = c("#D81B60","#FFC107","#1E88E5"))+
  ggtitle("")+
  labs(x = "Average minimum temperature (C) scaled", y = bquote('Upper bill surface area scaled'  ~(mm^2)))+
  theme(plot.title = element_text(size = 14, hjust = 0.5),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = c(0.2,0.8))
UBS.Inter.plot
```

### UBS Plots Wrapped

```{r UBS.wrap}
UBS.wrap <- ggarrange(UBS.Inter.plot, UBS.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
suppressWarnings(print(UBS.wrap))
cowplot::save_plot("PaperPlots/UBS.wrap.png", UBS.wrap, base_height = 5, base_width = 10)
```


## Nestling Total Bill Surface Area  

### Male TBS Model

```{r M.TBS.mdl}
M.TBS.mdl <- lm(TBS ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.TBS.mdl)
```

### Female TBS Model

```{r F.TBS.mdl}
F.TBS.mdl <- lm(TBS ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.TBS.mdl)
```

### All Nestlings TBS Model

```{r A.TBS.mdl}
A.TBS.mdl <- lm(TBS ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.TBS.mdl)
```

### Data frames for TBS Forest Plot

```{r TBS.dfs for fplot}
M.TBS.df <- fplot_df(M.TBS.mdl, "Male", "TBS")
F.TBS.df <- fplot_df(F.TBS.mdl, "Female", "TBS")
A.TBS.df <- fplot_df(A.TBS.mdl, "All", "TBS")

TBS.df <- rbind(M.TBS.df, F.TBS.df, A.TBS.df)
```

### TBS Forest Plot

```{r TBS.fplot}
TBS.fplot <- fplot(TBS.df)
TBS.fplot
#cowplot::save_plot("Plots/TBS.fplot.png", TBS.fplot, base_height = 4, base_width = 7)
```

### TBS Plots Wrapped

```{r TBS.wrap}
TBS.wrap <- ggarrange(TBSMinC.plot, TBS.fplot, ncol = 2, labels = c("A","B"), widths = c(1.6,1.4))
suppressWarnings(print(TBS.wrap))
cowplot::save_plot("PaperPlots/TBS.wrap.png", TBS.wrap, base_height = 5, base_width = 10)
```

## Nestling Total Exposed Culmen (TEC) 

### TEC by Minimum Temperature Plot

```{r TECMinC.plot}
TECMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = TEC, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="Sex",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unknown"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Total exposed culmen (mm)")+
  xlab("Average minimum temperature (C)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
TECMinC.plot
#cowplot::save_plot("Plots/TECMinC.plot.png", TECMinC.plot, base_height = 4, base_width = 7)
```

### Male TEC Model

```{r M.TEC.mdl}
M.TEC.mdl <- lm(TEC ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
summary(M.TEC.mdl)
```

### Female TEC Model

```{r F.TEC.mdl}
F.TEC.mdl <- lm(TEC ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
summary(F.TEC.mdl)
```

### All Nestlings TEC Model

```{r A.TEC.mdl}
A.TEC.mdl <- lm(TEC ~ MinC8_22 * PrecipSum8_22 + Weight, data = scaled.df)
summary(A.TEC.mdl)
```

### Data frames for TEC Forest Plot

```{r TEC.dfs for fplot}
M.TEC.df <- tidy(M.TEC.mdl, quick = FALSE)
  ci <- as_tibble(confint(M.TEC.mdl))
  M.TEC.df$ci.lower <- ci$`2.5 %`
  M.TEC.df$ci.upper <- ci$`97.5 %`
  M.TEC.df$Dataset <- "Male"
  M.TEC.df$Metric <- "TEC"
  M.TEC.df <- M.TEC.df[-1,]

F.TEC.df <- tidy(F.TEC.mdl, quick = FALSE)
  ci <- as_tibble(confint(F.TEC.mdl))
  F.TEC.df$ci.lower <- ci$`2.5 %`
  F.TEC.df$ci.upper <- ci$`97.5 %`
  F.TEC.df$Dataset <- "Female"
  F.TEC.df$Metric <- "TEC"
  F.TEC.df <- F.TEC.df[-1,]

A.TEC.df <- tidy(A.TEC.mdl, quick = FALSE)
  ci <- as_tibble(confint(A.TEC.mdl))
  A.TEC.df$ci.lower <- ci$`2.5 %`
  A.TEC.df$ci.upper <- ci$`97.5 %`
  A.TEC.df$Dataset <- "All"
  A.TEC.df$Metric <- "TEC"
  A.TEC.df <- A.TEC.df[-1,]
  
TEC.df <- rbind(M.TEC.df, F.TEC.df, A.TEC.df)
```

### TEC Forest Plot

```{r TEC.fplot}
TEC.fplot <- ggplot(data = TEC.df)+
    geom_errorbar(aes(x=term, ymin=ci.lower, ymax=ci.upper, color=Dataset),
                  linewidth=1, width=0.3, position=position_dodge(width=0.4))+
    geom_point(aes(x=term,y=estimate, color=Dataset), 
               shape = 16, size = 3, position=position_dodge(width=0.4))+
    scale_color_manual(name="", values=c("#000000","#E69F00","#56B4E9"),
                    labels=c("All","Female","Male"))+
    coord_flip()+
    geom_hline(yintercept = 0, color="red",size=1, linetype="dotted")+
    scale_x_discrete(labels=c("Min Temp","Min Temp * Precip","Precip","Weight"))+
    #scale_y_continuous(limits = c(-0.3,0.25), breaks = c(-0.25,0,0.25))+
    #ggtitle("")+
    ylab("Parameter estimate")+
    theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_blank(),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
TEC.fplot
#cowplot::save_plot("Plots/TEC.fplot.png", TEC.fplot, base_height = 4, base_width = 7)
```

### TEC Plots Wrapped

```{r TEC.wrap}
TEC.wrap <- ggarrange(TEC.fplot,TECMinC.plot, ncol = 2, labels = c("A","B"), widths = c(1.7,1.3))
cowplot::save_plot("PaperPlots/TEC.wrap.png", TEC.wrap, base_height = 5, base_width = 12)
#TEC.wrap
```

## Nestling Bill Nares to Tip (BNT) 

### BNT by Minimum Temperature Plot

```{r BNTMinC.plot}
BNTMinC.plot <- ggplot(data = df, aes(x = MinC8_22, y = BNT, color = Sex))+
  geom_jitter(width = 0.2, shape = 1, size = 1.8)+
  geom_smooth(method="lm", aes(fill = Sex), alpha = 0.2)+
  scale_color_manual(name="Sex",
                    values=c("#E69F00","#56B4E9","#000000"),
                    labels=c("Female","Male","Unknown"))+
  scale_fill_manual(values = c("#E69F00","#56B4E9","#000000"), guide = "none")+
  ylab("Bill nares to tip (mm)")+
  xlab("Average minimum temperature (C)")+
  theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
BNTMinC.plot
#cowplot::save_plot("Plots/BNTMinC.plot.png", BNTMinC.plot, base_height = 4, base_width = 7)
```

### Male BNT Model

```{r M.BNT.bmdl}
M.BNT.bmdl <- stan_glm(BNT ~ MinC8_22 * PrecipSum8_22 + Weight, 
                          data = M.scaled.df,
                              family = gaussian(),
                              algorithm = "sampling",
                              prior = student_t(df = 7, 0, 5), 
                              prior_intercept = student_t(df = 7, 0, 5),
                              chains = 10, iter = 10000, cores = 2, seed = 666)
#print(summary(M.BNT.bmdl), digits = 3)
#plot(M.BNT.bmdl)
```

```{r M.BNT.mdl}
# M.BNT.mdl <- lm(BNT ~ MinC8_22 * PrecipSum8_22 + Weight, data = M.scaled.df)
# summary(M.BNT.mdl)
```

### Female BNT Model

```{r F.BNT.bmdl}
F.BNT.bmdl <- stan_glm(BNT ~ MinC8_22 * PrecipSum8_22 + Weight, 
                          data = F.scaled.df,
                              family = gaussian(),
                              algorithm = "sampling",
                              prior = student_t(df = 7, 0, 5), 
                              prior_intercept = student_t(df = 7, 0, 5),
                              chains = 10, iter = 10000, cores = 2, seed = 666)
# print(summary(F.BNT.bmdl), digits = 3)
# plot(F.BNT.bmdl)
```

```{r F.BNT.mdl}
# F.BNT.mdl <- lm(BNT ~ MinC8_22 * PrecipSum8_22 + Weight, data = F.scaled.df)
# summary(F.BNT.mdl)
```

### All Nestlings BNT Model

```{r A.BNT.bmdl}
A.BNT.bmdl <- stan_glm(BNT ~ MinC8_22 * PrecipSum8_22 + Weight, 
                          data = scaled.df,
                              family = gaussian(),
                              algorithm = "sampling",
                              prior = student_t(df = 7, 0, 5), 
                              prior_intercept = student_t(df = 7, 0, 5),
                              chains = 10, iter = 10000, cores = 2, seed = 666)
# print(summary(A.BNT.bmdl), digits = 3)
# plot(A.BNT.bmdl)
```

### Data frames for BNT Forest Plot

```{r BNT.dfs for fplot}
M.BNT.df <- tidy(M.BNT.bmdl, quick = FALSE, conf.int = TRUE, conf.method = "HPDinterval", conf.level = 0.9, looic = TRUE)
  M.BNT.df$Dataset <- "Male"
  M.BNT.df$Metric <- "BNT"
  M.BNT.df <- M.BNT.df[-1,]

F.BNT.df <- tidy(F.BNT.bmdl, quick = FALSE, conf.int = TRUE, conf.method = "HPDinterval", conf.level = 0.9, looic = TRUE)
  F.BNT.df$Dataset <- "Female"
  F.BNT.df$Metric <- "BNT"
  F.BNT.df <- F.BNT.df[-1,]

A.BNT.df <- tidy(A.BNT.bmdl, quick = FALSE, conf.int = TRUE, conf.method = "HPDinterval", conf.level = 0.9, looic = TRUE)
  A.BNT.df$Dataset <- "All"
  A.BNT.df$Metric <- "BNT"
  A.BNT.df <- A.BNT.df[-1,]
  
B.BNT.df <- rbind(M.BNT.df, F.BNT.df)
```

### BNT Forest Plot

```{r B.BNT.fplot}
B.BNT.fplot <- ggplot(data = B.BNT.df)+
    geom_errorbar(aes(x=term, ymin=conf.low, ymax=conf.high, color=Dataset),
                  linewidth=1, width=0.3, position=position_dodge(width=0.4))+
    geom_point(aes(x=term,y=estimate, color=Dataset), 
               shape = 16, size = 3, position=position_dodge(width=0.4))+
    scale_color_manual(name="", values=c("#E69F00","#56B4E9"),
                    labels=c("Female","Male"))+
    coord_flip()+
    geom_hline(yintercept = 0, color="red",linewidth=1, linetype="dotted")+
    scale_x_discrete(labels=c("Min Temp","Min Temp * Precip","Precip","Weight"))+
    ylab("Parameter effect")+
    theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_blank(),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
B.BNT.fplot
#cowplot::save_plot("Plots/B.BNT.fplot.png", B.BNT.fplot, base_height = 4, base_width = 7)

#annotation: Points are coefficient posterior means. Error bars are 90% posterior uncertainty intervals.
```


```{r A.BNT.fplot}
A.BNT.fplot <- ggplot(data = A.BNT.df)+
    geom_errorbar(aes(x=term, ymin=conf.low, ymax=conf.high),
                  linewidth=1, width=0.3)+
    geom_point(aes(x=term,y=estimate), 
               shape = 16, size = 3)+
    scale_color_manual(name="", values="#000000")+
    coord_flip()+
    geom_hline(yintercept = 0, color="red",linewidth=1, linetype="dotted")+
    scale_x_discrete(labels=c("Min Temp","Min Temp * Precip","Precip","Weight"))+
    ylab("Parameter effect")+
    theme(plot.title = element_text(size = 16),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 14),
          axis.title.y = element_blank(),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
A.BNT.fplot

#annotation: Points are coefficient posterior means. Error bars are 90% posterior uncertainty intervals.
```

```{r BNT.pred}
M.BNT.pred <- ggpredict(M.BD.bmdl, terms = c("MinC8_22"), ppd = TRUE)
M.BNT.pred$Sex <- "M"

F.BNT.pred <- ggpredict(F.BD.bmdl, terms = c("MinC8_22"), ppd = TRUE)
F.BNT.pred$Sex <- "F"

A.BNT.pred <- ggpredict(A.BD.bmdl, terms = c("MinC8_22"), ppd = TRUE)
A.BNT.pred$Sex <- "A"

B.BNT.pred.df <- rbind(M.BNT.pred, F.BNT.pred)
```

###BNT Interaction plot (Female)
```{r F.BNT.Inter.plot}
F.BNT.Inter.plot <- plot_model(F.BNT.bmdl, type = "int", mdrt.values = "quart")+
  scale_color_manual(name="Precipitation levels",
                    values=c("#D81B60","#FFC107","#1E88E5"),
                    labels=c("Low","Median","High"))+
  scale_fill_manual(values = c("#D81B60","#FFC107","#1E88E5"))+
  ggtitle("Females")+
  xlab("")+
  ylab("")+
  theme(plot.title = element_text(size = 14, hjust = 0.5),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = "none")
F.BNT.Inter.plot
```

###BNT by Min Temp (Male)
```{r B.BNT.CE.plot}
M.BNT.CE.plot <- ggplot(data = M.BNT.pred, aes(x,predicted))+
  #geom_point(data = M.scaled.df, aes(x=MinC8_22, y=BNT), shape = 1)+
  geom_line(size = 0.7, color = "#56B4E9")+
  geom_ribbon(data = M.BNT.pred, aes(ymin=conf.low, ymax=conf.high, fill = Sex), alpha = 0.2)+
  scale_color_manual(name="", values="#56B4E9",guide = "none")+
  scale_fill_manual(values = "#56B4E9", guide = "none")+
  ggtitle("Males")+
  ylab("")+
  xlab("Average minimum temperature (C) scaled")+
  theme(plot.title = element_text(size = 14, hjust = 0.5),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
M.BNT.CE.plot

#annotation: Lines are the predicted conditional effects of temperature on tarsus length. Ribbons represent the posterior predictive distribution. 

#The posterior predictive distribution is the distribution of the outcome implied by the model after having used the observed data to update our beliefs about the unknown parameters. The posterior predictive distribution conditions on the observed outcome data in hand to update beliefs about the unknowns and the variation in the resulting distribution of predictions reflects the remaining uncertainty in our beliefs about the unknowns. <https://mc-stan.org/rstanarm/articles/rstanarm.html>
```

### BNT Plots Wrapped

```{r BNT.InterCE.wrap}
BNT.InterCE.wrap <- ggarrange(F.BNT.Inter.plot, M.BNT.CE.plot, ncol = 1)
BNT.InterCE.wrap <- annotate_figure(BNT.InterCE.wrap, left = text_grob('Bill nares to tip scaled (mm)', rot = 90, size = 14))
cowplot::save_plot("PaperPlots/BNT.InterCE.wrap.png", BNT.InterCE.wrap, base_height = 6, base_width = 6)
BNT.InterCE.wrap
```

##All bill metrics forest plots wrapped
```{r fplots wrapped}
fplot.wrap <- ggarrange(B.UB.fplot,B.BD.fplot,B.BNT.fplot,B.UBS.fplot, ncol = 2, nrow = 2, labels = c("                       UB", "  BD", "                      BNT", " UBS"), widths = c(1.3,1), common.legend = TRUE)
fplot.wrap <- annotate_figure(fplot.wrap, bottom = text_grob("Model parameter effect", size = 14))
cowplot::save_plot("PaperPlots/fplot.wrap.png", fplot.wrap, base_height = 8, base_width = 10)
```

##All bill metrics plots wrapped
```{r fplots wrapped}
BillPlots.wrap <- ggarrange(UB.Inter.wrap,B.BD.CE.plot,BNT.InterCE.wrap,UBS.InterCE.wrap, ncol = 2, nrow = 2)
BillPlots.wrap <- annotate_figure(BillPlots.wrap, bottom = text_grob("Average minimum temperature scaled (C)", size = 14))
cowplot::save_plot("PaperPlots/BillPlots.wrap.png", BillPlots.wrap, base_height = 15, base_width = 12)
```

