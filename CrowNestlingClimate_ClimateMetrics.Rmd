---
title: "Calculating Climate Metrics"
author: "Justin Mann"
date: "2022-09-27"
output: html_document
---

```{r libraries, include=FALSE}
library(tidyverse)
library(dplyr)
library(zoo)
library(lubridate)
```

## CLIMOD2 Data for Cornell University Weather Station
8 Game Farm Rd, Ithaca, NY 14850
Station IDs:
304174 (Coop)
USC00304174 (GHCN)
ITHN6 (NWS LI)

<http://www.nrcc.cornell.edu/>

<http://climod2.nrcc.cornell.edu/>

```{r raw data}
#Raw text file downloaded from climod2
rawclim.df <- read.table("climod2data1989-2022.txt", sep = ",", header = TRUE)

#Make variables numeric (will coerce NAs where data are missing)
rawclim.df$MaxTemp <- as.numeric(rawclim.df$MaxTemperature)
which(is.na(rawclim.df$MaxTemp))#[1] 1535
rawclim.df$MinTemp <- as.numeric(rawclim.df$MinTemperature)
which(is.na(rawclim.df$MinTemp))#[1] 1440 1536 1853 4401

rawclim.df$Precip <- as.numeric(rawclim.df$Precipitation)
rawclim.df$Snowfall <- as.numeric(rawclim.df$Snowfall)
rawclim.df$SnowDepth <- as.numeric(rawclim.df$SnowDepth)  
```

```{r metric and celcius conversions}
f2c <- function(x){
  x <- (5/9) * (x-32)
  return(x)
}
f2c(33)#[1] 0.556

rawclim.df$MaxC <- mapply(f2c, rawclim.df$MaxTemp)
rawclim.df$MinC <- mapply(f2c, rawclim.df$MinTemp)

in2cm <- function(x){
  x <- x * 2.54
  return(x)
}
in2cm(0.1)#[1] 0.254

rawclim.df$PrecipCM <- mapply(in2cm, rawclim.df$Precip)
rawclim.df$SnowfallCM <- mapply(in2cm, rawclim.df$Snowfall)
rawclim.df$SnowDepthCM <- mapply(in2cm, rawclim.df$SnowDepth)
```


```{r new data}
clim.df <- rawclim.df %>% 
  select(Date,MaxC,MinC,
         PrecipCM,SnowfallCM,SnowDepthCM)
#add year column
clim.df$Year <- lubridate::year(clim.df$Date)
#add Julian Day
clim.df$JulDay <- lubridate::yday(clim.df$Date)
#pad Julian Day with zeros
clim.df$JulDay <- str_pad(clim.df$JulDay, 3, pad = "0")
#join padded Julian Days with Year
my_cols <- c("Year", "JulDay")
clim.df$HatchDateJulYear <- do.call(paste, c(clim.df[my_cols], sep = ""))

```






## Climate Metrics

Objective: to match data on climate conditions during:

-   Incubation (conditions for 19 days prior to hatch date)

-   Post-hatch (conditions for 1-11, 12-22, 23-33, and 34-44 days after hatch date)

### Metric 1: Post-hatch Max Temp

```{r MaxTempMean1_11}
#zoo::rollapply(): align = 'left' applies to the succeeding days, while align = 'right' applies to the preceding days  
?zoo::rollapply()

#An 11-day rolling window calculates the mean of MaxTemp for the next 11 days
df$MaxTempMean1_11 <- zoo::rollapply(df$MaxTempC, width=11, FUN=mean, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(mean=mean(df[1:11,3]),metric=df[1,9])
#mean() calculation should match metric
```


```{r MaxTempMean12_22}
#MaxTempMean for days 12-22
df$MaxTempMean12_22 <- dplyr::lead(df$MaxTempMean1_11, n = 11)

#Code check
c(mean=mean(df[12:22,3]), metric=df[1,10])#mean() calculation should match metric
```

```{r}
print(df[12:22,3])#11 values
```


### Metric 2: Incubation Max Temp

```{r MaxTempMeanIncubation}
#MaxTemp mean for 19 days prior to hatch date
df$MeanMaxTempIncubation <- zoo::rollapply(df$MaxTempC, width=19, FUN=mean, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(mean=mean(df[1:19,3]), metric=df[19,11]) #mean() calculation should match metric
```

```{r}
print(df[1:19,3])#19 values
```
<br>

### Metric 3: Post-hatch Min Temp


```{r MinTempMean1_11}
#An 11-day rolling window calculates the mean of MinTemp for the next 11 days
df$MinTempMean1_11 <- zoo::rollapply(df$MinTempC, width=11, FUN=mean, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(mean=mean(df[1:11,4]),metric=df[1,12])
#mean() calculation should match metric
```

```{r MinTempMean12_22}
#MaxTempMean for days 12-22
df$MinTempMean12_22 <- dplyr::lead(df$MinTempMean1_11, n = 11)

#Code check
c(mean=mean(df[12:22,4]), metric=df[1,13])#mean() calculation should match metric
```


```{r MinTempMeanIncubation}
#MaxTemp mean for 19 days prior to hatch date
df$MeanMinTempIncubation <- zoo::rollapply(df$MinTempC, width=19, FUN=mean, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(mean=mean(df[1:19,4]), metric=df[19,14]) #mean() calculation should match metric
```


### Metric 4: Post-hatch Precipitation

```{r PrecipSum1_11}
df$PrecipSum1_11 <- zoo::rollapply(df$PrecipCM, width=11, FUN=sum, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check 
c(sum=sum(df[1:11,5], na.rm = TRUE), metric=df[1,15]) #sum() calculation should match metric
```

```{r}
print(df[1:11,5])#11 values)
```

```{r PrecipSum12_22}
#PrecipSum column that is 11 days ahead
df$PrecipSum12_22 <- dplyr::lead(df$PrecipSum1_11, n = 11)

#Code check
c(sum=sum(df[12:22,5], na.rm = TRUE), metric=df[1,16]) #sum() calculation should match metric
```

```{r}
print(df[12:22,10])
```
<br>


### Metric 4: Incubation Precipitation

```{r PrecipSumIncubation}
#PrecipSum column that looks back 19 days from hatch date
df$PrecipSumIncubation <- zoo::rollapply(df$PrecipCM, width=19, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(sum=sum(df[1:19,5], na.rm = TRUE), metric=df[19,17]) #sum() calculation should match metric
```

```{r}
print(df[1:19,5])#19 values
```

### Metric 5: Post-hatch Growing Degree Days

```{r GDDSum1_11}
#GDDSum column the first 11 days 
df$GDDSum1_11 <- zoo::rollapply(df$GDD, width=11, FUN=sum, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(sum=sum(df[112:122,8], na.rm = TRUE), metric=df[112,18]) #sum() calculation should match metric
```
```{r}
print(df[112:122,8])
```


```{r GDDSum12_22}
#GDDSum column that is 11 days ahead
df$GDDSum12_22 <- dplyr::lead(df$GDDSum1_11, n = 11)

#Code check
c(sum=sum(df[66:76,8], na.rm = TRUE), metric=df[55,19]) #sum() calculation should match metric
```
```{r}
print(df[66:76,8])
```


### Metric 6: Incubation Growing Degree Days

```{r GDDSumIncubation}
#GDDSum for the 19 days preceding hatch date
df$GDDSumIncubation <- zoo::rollapply(df$GDD, width=19, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)

#code check
c(sum=sum(df[111:129,8], na.rm = TRUE), metric=df[129,20]) #sum() should match metric
```
```{r}
print(df[111:129,8])#19 values
```


### Metric 7: Post-hatch Cooling Degree Days

```{r CDDSum1_11}
#CDDSum column the first 11 days 
df$CDDSum1_11 <- zoo::rollapply(df$CDD, width=11, FUN=sum, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(sum=sum(df[112:122,7], na.rm = TRUE), metric=df[112,21]) #sum() calculation should match metric
```
```{r}
print(df[112:122,7])#11 values
```


```{r CDDSum12_22}
#CDDSum column that is 11 days ahead
df$CDDSum12_22 <- dplyr::lead(df$CDDSum1_11, n = 11)

#Code check
c(sum=sum(df[66:76,7], na.rm = TRUE), metric=df[55,22]) #sum() calculation should match metric
```
```{r}
print(df[66:76,7])
```


### Metric 8: Incubation Cooling Degree Days

```{r CDDSumIncubation}
#CDDSum for the 19 days preceding hatch date
df$CDDSumIncubation <- zoo::rollapply(df$CDD, width=19, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)

#code check
c(sum=sum(df[111:129,7], na.rm = TRUE), metric=df[129,23]) #sum() should match metric
```
```{r}
print(df[111:129,7])#19 values
```

### Metric 9: Post-hatch Heating Degree Days

```{r HDDSum1_11}
#HDDSum column the first 11 days 
df$HDDSum1_11 <- zoo::rollapply(df$HDD, width=11, FUN=sum, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check
c(sum=sum(df[112:122,6], na.rm = TRUE), metric=df[112,24]) #sum() calculation should match metric
```
```{r}
print(df[112:122,6])
```


```{r HDDSum12_22}
#HDDSum column that is 11 days ahead
df$HDDSum12_22 <- dplyr::lead(df$HDDSum1_11, n = 11)

#Code check
c(sum=sum(df[66:76,6], na.rm = TRUE), metric=df[55,25]) #sum() calculation should match metric
```
```{r}
print(df[66:76,6])
```


### Metric 10: Incubation Heating Degree Days

```{r HDDSumIncubation}
#HDDSum for the 19 days preceding hatch date
df$HDDSumIncubation <- zoo::rollapply(df$HDD, width=19, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)

#code check
c(sum=sum(df[111:129,6], na.rm = TRUE), metric=df[129,26]) #sum() should match metric
```

```{r full climate metrics csv}
#write.csv(df, "ClimateMetricsFull.csv", row.names = FALSE)
```


```{r simplified df for analysis}
#New dataframe with the derived climate metrics
ClimateMetrics.df <- df %>% 
  select(Date,HatchDateJulYear,
         MaxTempMean1_11,MaxTempMean12_22,MeanMaxTempIncubation,
         MinTempMean1_11,MinTempMean12_22,MeanMinTempIncubation,
         PrecipSum1_11,PrecipSum12_22,PrecipSumIncubation,
         GDDSum1_11,GDDSum12_22,GDDSumIncubation,
         CDDSum1_11,CDDSum12_22,CDDSumIncubation,
         HDDSum1_11,HDDSum12_22,HDDSumIncubation)
```

```{r}
write.csv(ClimateMetrics.df, "ClimateMetrics.csv",
            row.names = FALSE)
```



