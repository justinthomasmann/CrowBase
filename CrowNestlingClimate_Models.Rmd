---
title: "CrowNestlingClimateModels"
author: "Justin Mann"
date: "2022-12-03"
output: html_document
---
```{r libraries echo=FALSE, include=FALSE}
library(tidyverse)
library(dplyr)
library(lme4) #frequentist models  
library(sjPlot) #plot_model & tab_model (blue = #377EB8)
library(ggpubr) #ggarrange
library(glmmTMB) #zi & overdispersed models
library(lmerTest) #lmerTest::step
library(ggeffects) #ggpredict
#PACKAGES FOR BAYESIAN MODELS
# library(rstanarm) #stan models
# library(shinystan) #stan model evaluation
#launch_shinystan_demo()
# library(loo) #use loo() to compare fits between bayesian models
library(plotly)
library(MuMIn) #dredge() for unsupervised model selection
library(AICcmodavg) #aictab() for AICc model comparisons
library(DHARMa)
theme_set(theme_classic())
```


## Crow Nestling Climate Models 


```{r dataframes}
#Males
M.df <- read.csv("MaleNestlingClimateJoined.csv",h=TRUE)

#Females 
F.df <- read.csv("FemaleNestlingClimateJoined.csv",h=TRUE)

#Both sexes
B.df <- rbind(F.df,M.df)
```


```{r}
summary(B.df)
```



```{r prepare variables}
#some metrics aren't recognized as numeric, so we'll coerce them as numeric 
is.numeric(B.df$TEC)
B.df$TEC <- as.numeric(B.df$TEC)
B.df$Skull <- as.numeric(B.df$Skull)

#Also renaming some variables in the process

#UB = upper bill
B.df$UB <- as.numeric(B.df$UpperBill)
#UBS = upper bill surface area
B.df$UBS <- as.numeric(B.df$UBillSurface)
#TBS = total bill surface area
B.df$TBS <- as.numeric(B.df$TotBillSurface)

#Make Month a factor for plotting
B.df$Month <- as.factor(B.df$Month)

#Simplify the df
B.df <- B.df %>% 
  select(Month,ID,CalcAge,HatchDateJulYear,AllSex,BillDepth,BillWidth,BillNT,TEC,UB,UBS,TBS,
         Skull,Tarsus,Weight,
         MaxTempMean1_11,MaxTempMean12_22,MeanMaxTempIncubation,
         MinTempMean1_11,MinTempMean12_22,MeanMinTempIncubation,
         GDDSum1_11,GDDSum12_22,GDDSumIncubation,
         PrecipSum1_11,PrecipSum12_22,PrecipSumIncubation)

summary(B.df)
```


```{r fix NAs in months}
#6 individuals with HatchDateJulYear 2002099 are showing NAs, should be 4 (April)
B.df$Month <- B.df$Month %>% replace_na("4")
#There is one lower case f instead of upper case F for one female
B.df$AllSex <- gsub('f', 'F', B.df$AllSex)
B.df$AllSex <- as.factor(B.df$AllSex)
summary(B.df)
```


```{r remaining NAs in morphometrics}
#7 more rows have NAs in morphometrics
sum(!complete.cases(B.df[-1]))

#Can remove them by uncommenting and running the following line
B.df <- na.omit(B.df)
summary(B.df)
```


```{r create bill metric ~ CalcAge residuals}
#Bill Depth
BDAge.mdl <- lm(data = B.df, BillDepth ~ CalcAge)
B.df$BDAgeResids <- BDAge.mdl$residuals  
hist(B.df$BDAgeResids)

#Bill Width
BWAge.mdl <- lm(data = B.df, BillWidth ~ CalcAge)
B.df$BWAgeResids <- BWAge.mdl$residuals
hist(B.df$BWAgeResids)

#BillNT
BNTAge.mdl <- lm(data = B.df, BillNT ~ CalcAge)
B.df$BNTAgeResids <- BNTAge.mdl$residuals
hist(B.df$BNTAgeResids)

#TEC
TECAge.mdl <- lm(data = B.df, TEC ~ CalcAge)
B.df$TECAgeResids <- TECAge.mdl$residuals
hist(B.df$TECAgeResids)

#UpperBill
UBAge.mdl <- lm(data = B.df, UB ~ CalcAge)
B.df$UBAgeResids <- UBAge.mdl$residuals
hist(B.df$UBAgeResids)

#Upper Bill Surface Area
UBSAge.mdl <- lm(data = B.df, UBS ~ CalcAge)
B.df$UBSAgeResids <- UBSAge.mdl$residuals
hist(B.df$UBSAgeResids)

#Total Bill Surface Area
TBSAge.mdl <- lm(data = B.df, TBS ~ CalcAge)
B.df$TBSAgeResids <- TBSAge.mdl$residuals
hist(B.df$TBSAgeResids)

#Skull
SkullAge.mdl <- lm(data = B.df, Skull ~ CalcAge)
B.df$SkullAgeResids <- SkullAge.mdl$residuals
hist(B.df$SkullAgeResids)

#Tarsus
TarsusAge.mdl <- lm(data = B.df, Tarsus ~ CalcAge)
B.df$TarsusAgeResids <- TarsusAge.mdl$residuals
hist(B.df$TarsusAgeResids)
```




```{r recreate male and female dfs}
#Now that B.df is cleaned and bill metric ~ age residuals are added, recreate male and female dfs
F.df <- subset(B.df, AllSex=="F")
M.df <- subset(B.df, AllSex=="M")
```



```{r female Bill Depth models}
F.BDMax1.mdl <- lm(data = F.df, BDAgeResids ~ MaxTempMean1_11*PrecipSum1_11 + Weight + Weight:BillDepth, na.action = "na.fail")
summary(F.BDMax1.mdl)
F.BDMax1.dredge <- dredge(F.BDMax1.mdl, rank = "AICc")
F.BDMax1.avg <- model.avg(F.BDMax1.dredge, subset = F.BDMax1.dredge$delta < 2, revised.var = TRUE, fit = TRUE)
summary(F.BDMax1.avg)
```
















```{r}
?aictab()
F.set1 <- list(F.UBillSurface1.mdl,F.UBillSurface2.mdl, F.UBillSurface3.mdl)
F.mdlnames1 <- c("WeightByAge", "WeightPlusAge","WeightAgeResiduals")
#Weight plus Age is the best fit because those two main effects are explaining way more variation than climate metrics, but this is expected and uninteresting, so I wouldn't consider that as a best-fit-model.
aictab(cand.set = F.set1, modnames = F.mdlnames1)
```











