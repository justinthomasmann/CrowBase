---
title: "Unsexed Nestling Analysis"
author: "Justin Mann"
date: "`r Sys.Date()`"
output: html_document
---

```{r libraries, include=FALSE}
library(tidyverse)
library(dplyr)
library(broom) #tidy() to create tibbles from model summaries
library(car) #vif
library(cowplot)
library(lme4) #frequentist models  
library(sjPlot) #plot_model & tab_model (blue = #377EB8)
library(ggpubr) #ggarrange
library(glmmTMB) #zi & overdispersed models
library(lmerTest) #lmerTest::step
library(ggeffects) #ggpredict
#PACKAGES FOR BAYESIAN MODELS
library(rstanarm) #stan models
library(shinystan) #stan model evaluation
#launch_shinystan_demo()
library(loo) #use loo() to compare fits between bayesian models
library(ggeffects)
library(plotly)
library(MuMIn) #dredge() for unsupervised model selection
library(AICcmodavg) #aictab() for AICc model comparisons
library(DHARMa)
library(DescTools)
library(umap)
library(tsne)
theme_set(theme_classic())
```

<br>

## Data

<br>

```{r dataframe}
df <- read.csv("CrowNestlingClimate_AllNestlingsCleaned&ClimateJoined.csv", h=TRUE)
df <- df[,-1]
#n=2035 nestlings, 39 variables
```

<br>

A column to hold decade bins for plotting

```{r creating decade bins}
df$Decades <- cut(df$Year, breaks = c(1988,1999,2010,2018), labels = c("89-99","00-10","11-18"))
df <- df %>% relocate(Decades, .before = Year)
```

<br>

## Normalize continuous data

<br>

Subtract each value from the mean (center) and divide it by the standard deviation

```{r scaling}
#categorical data  
unScaled.df <- df[,1:11]

#continuous data
dataToScale.df <- df[,12:40]

#scale continuous data
#?scale()
scaled.mat <- scale(dataToScale.df, center = TRUE, scale = TRUE)

#join unscaled and scaled data
scaled.df <- cbind(unScaled.df,scaled.mat)
```
<br>

Summarize unscaled data
```{r data summary }
summary(df)
```
<br> 

Summarize scaled data
```{r scaled data summary}
summary(scaled.df)
```


## Comparing Frequentist Models and Bayesian Models
<br>

Frequentist Bill Depth GDD Time 1
```{r BD Time 1 model}
BDTime1.scaled.mdl <- lm(data = scaled.df, BD ~ GDDSum1_11 * PrecipSum1_11 + Weight + CalcAge)
summary(BDTime1.scaled.mdl)
```
<br>

Bayesian Bill Depth GDD Time 1
```{r BD Time 1 bayes model}
BDTime1.bmdl <- stan_glm( BD ~ GDDSum1_11 * PrecipSum1_11 + Weight + CalcAge,
                              data = scaled.df,
                              family = gaussian(),
                              algorithm = "sampling",
                              prior = student_t(df = 7, 0, 5), 
                              prior_intercept = student_t(df = 7, 0, 5),
                              cores = 2, seed = 666)
print(summary(BDTime1.bmdl), digits = 3)
#launch_shinystan(BDTime1.bmdl)
```

```{r plot BD time 1}
BDGDDTime1.plot <- plot(BDTime1.bmdl, pars = c("GDDSum1_11","PrecipSum1_11","Weight","CalcAge","GDDSum1_11:PrecipSum1_11"))
BDGDDTime1.plot
```
<br>

Frequentist Bill Depth GDD Time 2
```{r BD Time 2 model}
BDTime2.scaled.mdl <- lm(data = scaled.df, BD ~ GDDSum12_22 * PrecipSum12_22 + Weight + CalcAge)
summary(BDTime2.scaled.mdl)
```
<br>

Bayesian Bill Depth GDD Time 2
```{r BD Time 2 bayes model}
BDTime2.bmdl <- stan_glm( BD ~ GDDSum12_22 * PrecipSum12_22 + Weight + CalcAge,
                              data = scaled.df,
                              family = gaussian(),
                              algorithm = "sampling",
                              prior = student_t(df = 7, 0, 5), 
                              prior_intercept = student_t(df = 7, 0, 5),
                              cores = 2, seed = 666)
print(summary(BDTime2.bmdl), digits = 3)
#launch_shinystan(BDTime1.bmdl)
```

```{r plot BD Time 2 model}
BDGDDTime2.plot <- plot(BDTime2.bmdl, pars = c("GDDSum12_22","PrecipSum12_22","Weight","CalcAge","GDDSum12_22:PrecipSum12_22"))
BDGDDTime2.plot
```
<br>

Bayesian Bill Depth GDD Incubation
```{r BD Incubation bayes model}
BDIncub.bmdl <- stan_glm( BD ~ GDDSumIncubation * PrecipSumIncubation + Weight + CalcAge,
                              data = scaled.df,
                              family = gaussian(),
                              algorithm = "sampling",
                              prior = student_t(df = 7, 0, 5), 
                              prior_intercept = student_t(df = 7, 0, 5),
                              cores = 2, seed = 666)
print(summary(BDIncub.bmdl), digits = 3)
#launch_shinystan(BDTime1.bmdl)
```

```{r plot BD ~ GDD Incubation model}
BDGDDIncub.plot <- plot(BDIncub.bmdl, pars = c("GDDSumIncubation","PrecipSumIncubation","Weight","CalcAge","GDDSumIncubation:PrecipSumIncubation"))
BDGDDIncub.plot
```

```{r ggarrange BD ~ GDD plots}
ggarrange(BDGDDIncub.plot,BDGDDTime1.plot,BDGDDTime2.plot, ncol = 1)
```

```{r BD GDD Incubation Inter plot}
BDGDDIncubInter.plot <- plot_model(BDIncub.bmdl, type = "int", mdrt.values = "quart")

BDGDDIncubInter.plot <- BDGDDIncubInter.plot +
  scale_color_discrete(name="Precip Levels", labels=c("25th Quartile","Median", "75th Quartile"))+
  ylab("Upper Bill")+
  xlab("GDD Incubation")+
  theme(plot.title = element_blank(),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
BDGDDIncubInter.plot
```

```{r BD GDD Time 2 Inter plot}
BDGDDTime2Inter.plot <- plot_model(BDTime2.bmdl, type = "int", mdrt.values = "quart")

BDGDDTime2Inter.plot <- BDGDDTime2Inter.plot +
  scale_color_discrete(name="Precip Levels", labels=c("25th Quartile","Median", "75th Quartile"))+
  ylab("Depth Bill")+
  xlab("GDD Time 2")+
  theme(plot.title = element_blank(),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          legend.position = "top",
          plot.margin = margin(15,15,15,15))
BDGDDTime2Inter.plot
```

```{r BD arrange inter plots}
ggarrange(BDGDDIncubInter.plot,BDGDDTime2Inter.plot, ncol = 2)
```

Tarsus models

```{r Tarsus Time 1 model}
TarsusTime1.scaled.mdl <- lm(data = scaled.df, Tarsus ~ GDDSum1_11 * PrecipSum1_11 + Weight + CalcAge)
summary(TarsusTime1.scaled.mdl)
```

```{r Tarsus Time 2 model}
TarsusTime2.scaled.mdl <- lm(data = scaled.df, Tarsus ~ GDDSum12_22 * PrecipSum12_22 + Weight + CalcAge)
summary(TarsusTime2.scaled.mdl)
```

```{r Tarsus Incub model}
TarsusIncub.scaled.mdl <- lm(data = scaled.df, Tarsus ~ GDDSumIncubation * PrecipSumIncubation + Weight + CalcAge)
summary(TarsusIncub.scaled.mdl)
```
