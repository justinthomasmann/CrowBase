---
title: "Testing climwin"
author: "Justin Mann"
date: "`r Sys.Date()`"
output: html_document
---

```{r libraries, include=FALSE}
library(climwin)
library(tidyverse)
library(lubridate)
library(sjPlot)
library(AICcmodavg)
```

## Testing sliding window approach used in Liu et al. 2023 J of Avian Biol

The goal is to identify the window of time that best explains variation in nestling morphometrics. In the context of our project, this program will detect the post-hatch time period ('window' of days) over which our nestling's bills are most responsive to climatic conditions. Mathematically, it's simply running the same model, with every possible sequence of days inside a user-defined window of time, and then comparing AIC values across all models.

```{r climwin packaged data}
egC.df <- MassClimate
egB.df <- Mass 
```
<br>

```{r our data}
df <- read.csv("CrowNestlingClimate_AllNestlingsCleaned&ClimateJoinedNEW.csv", h=TRUE)

#coerce our date vector to an R date
df$Date <- as.Date(df$Date, format = "%m/%d/%Y")

#create a date that is 22 days post-hatch (climwin is built to look backwards from a specified date, not forwards)
df$PostHatch22Date <- df$Date + 22

#make a new vector called CalcAgeDecimal so that CalcAge can be an integer instead
df$CalcAgeDecimal <- df$CalcAge
df$CalcAge <- round(df$CalcAgeDecimal)

#move variables in prep for scaling
df <- df %>% 
  relocate(CalcAge, .after = AllSex) %>% 
  relocate(CalcAgeDecimal, .after = CalcAge) %>% 
  relocate(PostHatch22Date, .after = Date)

```
<br>


## Normalizing continuous data

R's scale function subtracts each value from the mean (centers) and divide it by the standard deviation (scales).

```{r scaling}
#?scale()

#separate categorical and continous data
categorical.df <- df[,1:10]
continuous.df <- df[,11:41]

#scale continuous data
scaled.mat <- scale(continuous.df, center = TRUE, scale = TRUE)

#join unscaled and scaled data
scaled.df <- cbind(categorical.df,scaled.mat)
```
<br>

```{r data frame with only sexed nestlings}
#Males Scaled
M.scaled.df <- subset(scaled.df, AllSex=="M")
#Males Unscaled
M.df <- subset(df, AllSex=="M")

#Females Scaled
F.scaled.df <- subset(scaled.df, AllSex=="F")
#Females Unscaled
F.df <- subset(df, AllSex=="F")

#Both sexes scaled
B.scaled.df <- rbind(F.scaled.df,M.scaled.df)
#Both sexes unscaled
B.df <- rbind(F.df,M.df)
```
<br>

```{r null models}
weight.mdl <- lm(data = F.scaled.df, BD ~ Weight)
age.mdl <- lm(data = F.scaled.df, BD ~ CalcAgeDecimal)
ageWeight.mdl <- lm(data = F.scaled.df, BD ~ Weight + CalcAgeDecimal)
ageWeightInter.mdl <- lm(data = F.scaled.df, BD ~ Weight * CalcAgeDecimal)

null.mdls <- list(weight.mdl,age.mdl,ageWeight.mdl,ageWeightInter.mdl)
null.modnames <- c("weight.mdl","age.mdl","ageWeight.mdl","ageWeightInter.mdl")
aictab(cand.set = null.mdls, modnames = null.modnames)

plot_model(ageWeightInter.mdl,type = "int")
summary(ageWeightInter.mdl)
```





```{r formatting for climwin}
#format post-hatch date to dd/mm/yyyy
#make cDate (climate date) for climate data and bDate (biological date) for nestling data
scaled.df$cDate <- format(strptime(scaled.df$PostHatch22Date, format = "%Y-%m-%d"), "%d/%m/%Y")
# bDate (biological date) for nestling data
scaled.df$bDate <- scaled.df$cDate

#remove leading 
scaled.df$cDate <- str_remove(scaled.df$cDate, "^0+")
nestl.df$climDate <- as.factor(nestl.df$climDate)
```

```{r slidingwin test}
test1 <- slidingwin(xvar = list(C10 = clim.df$C10),
           cdate = clim.df$climDate,
           bdate = nestl.df$climDate,
           baseline = lm(BD ~ Weight + CalcAge, data = nestl.df),
           cinterval = "day",
           range = c(22,0),
           type = "relative",
           stat = "sum",
           func = "lin")
```
```{r}
test1[[1]]$Dataset
test1[[1]]$BestModel
```
<br>

## Helpful code (not run) but worth saving 

Date formatting and adding leading zeros.
```{r saved formatting code}
# #climate data
# clim.df <- read.csv("ClimateMetrics_AllMonths1989-2022.csv", h=TRUE)
# #coerce Date to class Date
# clim.df$Date <- as.Date(clim.df$Date)
# class(clim.df$Date)
# clim.df$climDate <- format(strptime(clim.df$Date, format = "%Y-%m-%d"), "%d/%m/%Y")
# clim.df$climDate <- str_remove(clim.df$climDate, "^0+")
# clim.df$climDate <- as.factor(clim.df$climDate)
```
