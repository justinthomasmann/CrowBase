---
title: "Nestlings and Climate"
author: "Justin Mann"
date: "2022-09-27"
output: html_document
---

```{r libraries, include=FALSE}
library(tidyverse)
library(dplyr)
library(zoo)
```

## CLIMOD2 Dataset for Cornell University Station

```{r data frame}
df <- read.csv("IthacaWeatherData1990_2020.csv", h=TRUE)

#coerce climate variables to class numeric 
df$MaxTemp <- as.numeric(df$MaxTemp)
df$Precip <- as.numeric(df$Precip)
df$HDD <- as.numeric(df$HDD)
```


```{r MaxTempMean1_11}
#create columns to contain mean MaxTemp for 11 day rolling windows for each julian day

df$MaxTempMean1_11 <- zoo::rollapply(df$MaxTemp, width=11, FUN=mean, align = 'left', fill = NA, partial = TRUE, na.rm = TRUE)

#Code check: Is MaxTempMean1_11 calculating the mean Max temp for the following 11 days.
c(mean(df[1:11,7]), df[1,16]) #manually calculated mean matches MaxTempMean1_11

```


```{r MaxTempMean12_22}
#Create MaxTemp column that is 11 days ahead
df$MaxTempMean12_22 <- dplyr::lead(df$MaxTempMean1_11, n = 11)

#Code check: Is MaxTempMean12_22 calculating the mean Max temp for the second window of 11 days.
c(mean(df[12:22,7]), df[1,17]) #manually calculated mean matches MaxTempMean12_22
```


```{r MaxTempMean23_33}
#Create MaxTemp column that is 22 days ahead
df$MaxTempMean23_33 <- dplyr::lead(df$MaxTempMean12_22, n = 11)

#Code check: Is MaxTempMean23_33 calculating the mean Max temp for the third window of 11 days.
c(mean(df[23:33,7]), df[1,18]) #manually calculated mean matches MaxTempMean23_33
```


```{r MaxTempMean34_44}
#Create MaxTemp column that is 33 days ahead
df$leadMax34_44 <- dplyr::lead(df$MaxTempMean23_33, n = 11)

#Code check: Is MaxTempMean33_43 calculating the mean Max temp for the fourth window of 11 days.
c(mean(df[34:44,7]), df[1,19]) #manually calculated mean matches MaxTempMean33_43
```


```{r MaxTempMean19}
df$leadMax19 <- dplyr::lead(df$MaxTemp, n = 9)
df$leadMean19 <- zoo::rollmean(df$leadMax19, k=19, fill = NA, align = 'right')
df$MaxTempMean19 <- dplyr::lag(df$leadMean19, n = 9)
```

```{r code check}
#verify that MaxTempMean19 is accurately calculating the mean Max temp for the previous 19 days.
c(mean(df[10:28,7]), df[28,21]) #manually calculated mean should match MaxTempMean11
```


```{r TotPrecip11}
df$TotPrecip11 <- zoo::rollapply(df$Precip, width=11, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)
```

```{r code check}
#verify that TotPrecip11 is accurately calculating the summed precip for the previous 11 days.
c(sum(df[1:11,10], na.rm = TRUE), df[11,22]) #manually calculated sum should match TotPrecip11
```


```{r TotPrecip19}
df$TotPrecip19 <- zoo::rollapply(df$Precip, width=19, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)
```

```{r code check}
#verify that TotPrecip19 is accurately calculating the summed precip for the previous 19 days.
c(sum(df[11:29,10], na.rm = TRUE), df[29,23]) #manually calculated sum should match TotPrecip19
```


```{r TotHDD11}
df$TotHDD11 <- zoo::rollapply(df$HDD, width=11, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)
```

```{r code check}
#verify that TotHDD11 is accurately calculating the summed HDD for the previous 11 days.
c(sum(df[111:121,13], na.rm = TRUE), df[121,24]) #manually calculated sum should match TotHDD11
```


```{r TotHDD19}
df$TotHDD19 <- zoo::rollapply(df$HDD, width=19, FUN=sum, align = 'right', fill = NA, partial = TRUE, na.rm = TRUE)
```

```{r code check}
#verify that TotHDD19 is accurately calculating the summed HDD for the previous 19 days.
c(sum(df[111:129,13], na.rm = TRUE), df[129,25]) #manually calculated sum should match TotHDD19
```


```{r new dataframe}
#New dataframe with the derived climate metrics
climMetrics.df <- as.data.frame(df[60:11514,c(1:6, 18, 21:25)])
```


```{r}
write.csv(climMetrics.df, "C:\\Users\\Justin Mann\\Documents\\RProjects\\CrowBase\\ClimateMetrics.csv",
          row.names = FALSE)
```


